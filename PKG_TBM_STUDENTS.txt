--CREATING A PACKAGE FOR EXTRACTING EMPLOYEES LIST FROM TBM_EMPLOYEES TABLE ACCORDING TO THE PASSED PARAMETER--


CREATE OR REPLACE PACKAGE PKG_TBM_STUDENTS AS 
PROCEDURE PR_GET_TBM_STUDENTS_LIST
   (
   P_ROLL_NO IN TBM_STUDENTS.ROLL_NO%TYPE,
   P_FIRST_NAME IN TBM_STUDENTS.FIRST_NAME%TYPE,
   P_MIDDLE_NAME IN TBM_STUDENTS.MIDDLE_NAME%TYPE,
   P_LAST_NAME IN TBM_STUDENTS.LAST_NAME%TYPE,
   P_PHONE_NO IN TBM_STUDENTS.PHONE_NO%TYPE,
   P_ADDRESS IN TBM_STUDENTS.ADDRESS%TYPE,
   P_EMAIL IN TBM_STUDENTS.EMAIL%TYPE,
   P_JOIN_DATE IN TBM_STUDENTS.JOIN_DATE%TYPE,
   P_SECTION_ID IN TBM_STUDENTS.SECTION_ID%TYPE,
   P_REC_SET OUT SYS_REFCURSOR,
   P_REP_ID OUT  RPT_STUDENTS_LIST.REPORT_ID%TYPE
   );

END PKG_TBM_STUDENTS;


CREATE OR REPLACE PACKAGE BODY PKG_TBM_STUDENTS AS 
PROCEDURE PR_GET_TBM_STUDENTS_LIST
   (
   P_ROLL_NO IN TBM_STUDENTS.ROLL_NO%TYPE,
   P_FIRST_NAME IN TBM_STUDENTS.FIRST_NAME%TYPE,
   P_MIDDLE_NAME IN TBM_STUDENTS.MIDDLE_NAME%TYPE,
   P_LAST_NAME IN TBM_STUDENTS.LAST_NAME%TYPE,
   P_PHONE_NO IN TBM_STUDENTS.PHONE_NO%TYPE,
   P_ADDRESS IN TBM_STUDENTS.ADDRESS%TYPE,
   P_EMAIL IN TBM_STUDENTS.EMAIL%TYPE,
   P_JOIN_DATE IN TBM_STUDENTS.JOIN_DATE%TYPE,
   P_SECTION_ID IN TBM_STUDENTS.SECTION_ID%TYPE,
   P_REC_SET OUT SYS_REFCURSOR,
   P_REP_ID OUT  RPT_STUDENTS_LIST.REPORT_ID%TYPE
   )
IS
   V_STR VARCHAR2(4000);
   V_REFCUR_1 SYS_REFCURSOR;
   TYPE V_STDINFOTYPE IS TABLE OF TBM_STUDENTS%ROWTYPE;
   V_STDINFO V_STDINFOTYPE;
   V_SEQNUMBER RPT_STUDENTS_LIST.REPORT_ID%TYPE;
   --
BEGIN

   V_STR := 'SELECT * FROM TBM_STUDENTS WHERE 1=1';
   ---ADDING UP CONDITIONS NOW---
   
   IF TRIM(P_ROLL_NO) IS NOT NULL THEN
      V_STR := V_STR||' AND ROLL_NO = '|| TRIM(P_ROLL_NO)||'';
   END IF;
   
   IF TRIM(P_FIRST_NAME) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(FIRST_NAME) LIKE '''||TRIM(P_FIRST_NAME)||'%''';
   END IF;
   
   IF TRIM(P_MIDDLE_NAME) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(MIDDLE_NAME) LIKE '''||TRIM(P_MIDDLE_NAME)||'%''';
   END IF;
   
   IF TRIM(P_LAST_NAME) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(LAST_NAME) LIKE '''||TRIM(P_LAST_NAME)||'%''';
   END IF;
   
   IF TRIM(P_PHONE_NO) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(PHONE_NO) LIKE '''||TRIM(P_PHONE_NO)||'%''';
   END IF;
   
   IF TRIM(P_EMAIL) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(EMAIL) LIKE '''||TRIM(P_EMAIL)||'%''';
   END IF;
     
   IF TRIM(P_SECTION_ID) IS NOT NULL THEN
      V_STR := V_STR||' AND SECTION_ID = '|| TRIM(P_SECTION_ID)||'';
   END IF;
     
   IF TRIM(P_ADDRESS) IS NOT NULL THEN
      V_STR := V_STR||' AND UPPER(ADDRESS) LIKE '''||TRIM(P_ADDRESS)||'%''';
   END IF;
   
   IF TRIM(P_JOIN_DATE) IS NOT NULL THEN
      V_STR := V_STR||' AND JOIN_DATE = '|| TRIM(P_JOIN_DATE)||'';
   END IF;   
   ----
   DBMS_OUTPUT.PUT_LINE(V_STR);
   ---
   OPEN V_REFCUR_1 FOR V_STR;
   FETCH V_REFCUR_1 BULK COLLECT INTO V_STDINFO;
   
   SELECT TO_CHAR(SYSDATE, 'RRMMDDHH24MISS')||'-'||LPAD(SEQ_REPORT.NEXTVAL, 8, '0') 
      INTO P_REP_ID FROM DUAL;
      
   FOR i IN V_STDINFO.FIRST..V_STDINFO.LAST
   LOOP
      INSERT INTO RPT_STUDENTS_LIST
                  (REPORT_ID,SNO,ROLL_NO,FIRST_NAME,MIDDLE_NAME,LAST_NAME,EMAIL,PHONE_NO,SECTION_ID,ADDRESS,JOIN_DATE)
            VALUES(P_REP_ID,i,V_STDINFO(i).ROLL_NO,V_STDINFO(i).FIRST_NAME,V_STDINFO(i).MIDDLE_NAME,V_STDINFO(i).LAST_NAME,V_STDINFO(i).EMAIL,
                        V_STDINFO(i).PHONE_NO,V_STDINFO(i).SECTION_ID,V_STDINFO(i).ADDRESS,V_STDINFO(i).JOIN_DATE);
      COMMIT;
   END LOOP;
   CLOSE V_REFCUR_1;
   ---
   OPEN P_REC_SET FOR SELECT * FROM RPT_STUDENTS_LIST
      ORDER BY REPORT_ID ASC, SNO ASC;
   ---
   DELETE FROM RPT_STUDENTS_LIST  
      WHERE REPORT_ID = P_REP_ID;
   COMMIT;
   ---
END PR_GET_TBM_STUDENTS_LIST;

END PKG_TBM_STUDENTS;



--CALLING PROCEDURE EXAMPLE--

DECLARE
   P_REP_ID RPT_STUDENTS_LIST.REPORT_ID%TYPE;
   V_REC_SET SYS_REFCURSOR;
BEGIN
   PKG_TBM_STUDENTS.PR_GET_TBM_STUDENTS_LIST(1,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,V_REC_SET,P_REP_ID);
   DBMS_OUTPUT.PUT_LINE( 'REPORT ID :: '||P_REP_ID);

END;
/



