--THIS CREATES A TRIGGER WHICH RECORDS CHANGED COLUMN VALUE IN TBM_AUDIT_LOG TABLE_NAME
--THE SAMPLE CONTAINS PROCEDURES ONLY FOR COLUMNS FIRST_NAME,LAST_NAME AND SALARY
--
--PACKAGE CREATION
CREATE OR REPLACE PACKAGE PKG_EMP_2 AS
PROCEDURE PR_AUDIT_FIRST_NAME(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   );
--
PROCEDURE PR_AUDIT_LAST_NAME(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   );
--
PROCEDURE PR_AUDIT_SALARY(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   );
--
END PKG_EMP_2;

CREATE OR REPLACE PACKAGE BODY PKG_EMP_2 AS
PROCEDURE PR_AUDIT_FIRST_NAME(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   ) IS 
BEGIN
   IF P_OLD_VALUE <> P_NEW_VALUE THEN
      INSERT INTO TBM_AUDIT_LOG(USER_NAME,TABLE_NAME,COLUMN_NAME,OLD_VALUE,NEW_VALUE)
         VALUES(P_USER_NAME,P_TABLE_NAME,P_COLUMN_NAME,P_OLD_VALUE,P_NEW_VALUE);
     -- COMMIT;
   END IF;
END PR_AUDIT_FIRST_NAME;
--
PROCEDURE PR_AUDIT_LAST_NAME(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   ) IS 
BEGIN
   IF P_OLD_VALUE <> P_NEW_VALUE THEN
      INSERT INTO TBM_AUDIT_LOG(USER_NAME,TABLE_NAME,COLUMN_NAME,OLD_VALUE,NEW_VALUE)
         VALUES(P_USER_NAME,P_TABLE_NAME,P_COLUMN_NAME,P_OLD_VALUE,P_NEW_VALUE);
     -- COMMIT;
   END IF;
END PR_AUDIT_LAST_NAME;
--
PROCEDURE PR_AUDIT_SALARY(
   P_USER_NAME VARCHAR2,
   P_TABLE_NAME VARCHAR2,
   P_COLUMN_NAME VARCHAR2,
   P_OLD_VALUE VARCHAR2,
   P_NEW_VALUE VARCHAR2
   ) IS 
BEGIN
   IF P_OLD_VALUE <> P_NEW_VALUE THEN
      INSERT INTO TBM_AUDIT_LOG(USER_NAME,TABLE_NAME,COLUMN_NAME,OLD_VALUE,NEW_VALUE)
         VALUES(P_USER_NAME,P_TABLE_NAME,P_COLUMN_NAME,P_OLD_VALUE,P_NEW_VALUE);
     -- COMMIT;
   END IF;
END PR_AUDIT_SALARY;
--
END PKG_EMP_2;

--TRIGGER CREATION

CREATE OR REPLACE TRIGGER TRG_EMP_2
   AFTER UPDATE ON EMP_2
   FOR EACH ROW
DECLARE
   V_USERNAME VARCHAR2(20);
   V_TABLE_NAME VARCHAR2(20);
BEGIN
   V_TABLE_NAME:='EMP_2';
   SELECT USER INTO V_USERNAME FROM DUAL;
   --
   PKG_EMP_2.PR_AUDIT_FIRST_NAME(V_USERNAME,V_TABLE_NAME,'FIRST_NAME',:OLD.FIRST_NAME,:NEW.FIRST_NAME);
   --
   PKG_EMP_2.PR_AUDIT_LAST_NAME(V_USERNAME,V_TABLE_NAME,'LAST_NAME',:OLD.LAST_NAME,:NEW.LAST_NAME);
   --
   PKG_EMP_2.PR_AUDIT_SALARY(V_USERNAME,V_TABLE_NAME,'SALARY',:OLD.SALARY,:NEW.SALARY);   
   --
END TRG_EMP_2;